<!DOCTYPE html>
<html lang="en">

<head>
    <title>Testing the user register api</title>
    <style>
        body {
            background-color: rgb(56, 56, 56);
        }

        button {
            background-color: rgb(67, 69, 90);
            color: white;
            font-size: 16px;
        }

        button:hover {
            background-color: rgb(84, 87, 112);
        }

        pre {
            color: white;
            font-size: 16px;
        }

        #console-output{
            border: 1px white solid;
        }
    </style>
</head>

<body>
    <button onclick="getLocation(callRegisterApi, showError)">Send a post request to the /user/register</button>
    <button onclick="getLocation(showPosition, showError)">test getting location</button>
    <br />
    <button onclick="getLocation(callMiddlewareTest, showError)">Send a post request to the userMiddleware</button>
    <button onclick="getLocation(callFrontendTest, showError)">Send a post request to the frontendTest</button>
    <br/>
    <button onclick="getLocation(getPotholesTest, showError)">Get Potholes from location</button>
    <pre id="coord-output"></pre>
    <hr/>
    <pre>Set your own custom lat/lon (Note: the userMiddleware will detect this and block the request)</pre>
    <input type="text" id="custom-lat" placeholder="Latitude">
    <input type="text" id="custom-lon" placeholder="Longitude">
    <button type="button" id="custom-pos-save" onclick="saveCustomLocation()">Save Custom Location</button>
    <button type="button" id="custom-pos-clear" onclick="clearCustomLocation()">Clear Custom Location</button>
    <hr/>
    <button type="button" id ="show-production-console" onclick="showConsole()">Load Server Console</button>
    <pre id="console-output"></pre>
    <button type="button" id="submitPotholeToDB" onclick="getLocation(submitPotholeToDB, showError)">Submit Pothole to Database</button>

    <script>
        var testLatitude = undefined; 
        var testLongitude = undefined;

        const custoLat = document.getElementById("custom-lat");
        const custoLon = document.getElementById("custom-lon");
        const coordOutput = document.getElementById("coord-output");
        const consoleOutput = document.getElementById("console-output");

        function getLocation(success, error) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(success, error);
            } else {
                coordOutput.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        function showPosition(position) {
            if(testLatitude){
                coordOutput.innerHTML = "Custom Latitude: " + testLatitude +
                " Custom Longitude: " + testLongitude;
            } else {
                coordOutput.innerHTML = "Latitude: " + position.coords.latitude +
                " Longitude: " + position.coords.longitude;
            }
            console.log(position);
        }

        function saveCustomLocation() {
            testLatitude = custoLat.value;
            testLongitude = custoLon.value;
            coordOutput.innerHTML = "Custom Latitude: " + testLatitude +
                " Custom Longitude: " + testLongitude;
        }

        function clearCustomLocation() {
            testLatitude = undefined;
            testLongitude = undefined;
            custoLat.value = "";
            custoLon.value = "";
        }

        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                coordOutput.innerHTML = "User denied the request for Geolocation.";
                    break;
                case error.POSITION_UNAVAILABLE:
                coordOutput.innerHTML = "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                coordOutput.innerHTML = "The request to get user location timed out.";
                    break;
                case error.UNKNOWN_ERROR:
                coordOutput.innerHTML = "An unknown error occurred.";
                    break;
            }
        }

        async function callRegisterApi(position) {
            const data = {
                "latitude": testLatitude || position.coords.latitude,
                "longitude": testLongitude || position.coords.longitude
            };

            response = await fetch('./user/register', {
                method: 'POST',
                headers: {
                    'Content-type': 'application/json'
                },
                body: JSON.stringify(data),
            });

            text = await response.text();
            console.log(text);
        }

        async function callMiddlewareTest(position) {
            const data = {
                "latitude": testLatitude || position.coords.latitude,
                "longitude": testLongitude || position.coords.longitude
            };

            response = await fetch('./api/mid_test', {
                method: 'POST',
                headers: {
                    'Content-type': 'application/json'
                },
                body: JSON.stringify(data),
            });

            text = await response.text();
            console.log(text);

        }
        async function callSubmitPothole(position) {
            const data = {
                "latitude": testLatitude || position.coords.latitude,
                "longitude": testLongitude || position.coords.longitude
            };
            //GET for now, but needs to be a POST
            response = await fetch('./api/submitpothole', {
                method: 'GET',
                headers: {
                    'Content-type': 'application/json'
                },
                //body: JSON.stringify(data),
            });

            text = await response.text();
            console.log(text);

        }

        async function callFrontendTest(position) {
            const data = {
                "latitude": testLatitude || position.coords.latitude,
                "longitude": testLongitude || position.coords.longitude
            };

            response = await fetch('./api/frontend_test', {
                method: 'POST',
                headers: {
                    'Content-type': 'application/json'
                },
                body: JSON.stringify(data),
            });

            text = await response.text();
            console.log(text);

        }
        async function showConsole(){
            response = await fetch('./api/show_console', {
                method: 'GET'
            });

            text = await response.text();
            consoleOutput.innerHTML = text;
        }

        async function submitPotholeToDB(position) {
            const data = {
                "latitude": testLatitude || position.coords.latitude,
                "longitude": testLongitude || position.coords.longitude
            };
            console.log(data);
            response = await fetch('./api/submitpothole', {
                method: 'POST',
                headers: {
                    'Content-type': 'application/json'
                },
                body: JSON.stringify(data),
            });

            text = await response.text();
            console.log(text);
        };

        async function getPotholesTest(position) {
            const data = {
                lat: testLatitude || position.coords.latitude,
                lng: testLongitude || position.coords.longitude
            };
            const url = './api/potholes' + "?latitude=" + data.lat + "&longitude=" + data.lng + "&filter=city";
        
            response = await fetch(url, {
                method: "GET"
            });
            text = await response.json();
            console.log(text);
        }
    </script>
</body>
</html>